<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="footerStytles.css">
  <title>Chit Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
/* General Reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  background-color: #f4f4f9;
  color: #333;
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header {
  background: linear-gradient(45deg, #ff6f61, #ff9a8b); /* Gradient for header */
  color: white;
  text-align: center;
  padding: 12px;
  font-size: 16px;
  font-weight: bold;
  position: relative; /* Change to relative so it scrolls with the content */
  width: 100%;
  z-index: 10;
}

.navItem {
  display: block;
  width: 80%;
  margin: 10px auto;
  padding: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: linear-gradient(145deg, #fff, #e4e4e4); /* Light gradient for nav items */
  transition: all 0.3s ease;
}

.navItem:focus {
  outline: 2px solid #007bff;
  border-color: #007bff;
}

button {
  background: linear-gradient(45deg, #1e90ff, #00bfff); /* Blue gradient for button */
  color: black;
  border: none;
  cursor: pointer;
  font-size: 16px;
  font-weight:bold;
  padding: 10px 18px;
  width: 70%;
  border-radius: 8px;
  margin-top: 12px;
  transition: background 0.3s ease;
}

button:hover {
  background: linear-gradient(45deg, #00bfff, #1e90ff); /* Inverted gradient on hover */
}

button:focus {
  border: 2px solid yellow;
}

/* Page Layout */
#mainPage,
#chatPage {
  flex: 1;
  overflow: auto;
  display: none;
}

#mainPage.active,
#chatPage.active {
  display: flex;
  flex-direction: column;
}

/* Private Chat List */
#privateChatList {
  padding: 12px;
  color: black;
  font-weight: bold;
  text-align: center;
}

#chatListContainer {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-item {
  padding: 12px;
  background: linear-gradient(145deg, #ffffff, #f7f7f7); /* Gradient background for chat items */
  border-radius: 8px;
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
}

.chat-item:focus {
  outline: 2px solid #ff6f61; /* Gradient focus effect */
  border-color: #ff6f61;
}

.chat-item:hover {
  background: linear-gradient(145deg, #f0f0f0, #ffffff);
}

/* Chat Page */
#chatHeader {
  font-size: 18px;
  font-weight: bold;
  padding: 12px;
  background: linear-gradient(45deg, #ff6f61, #ff9a8b); /* Gradient for header */
  color: white;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 10;
}

#chatBox {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  background-color: #e9ecef;
  border-top: 1px solid #ccc;
}

.message {
  padding: 12px;
  margin: 8px 0;
  border-radius: 8px;
  max-width: 70%;
  font-size: 14px;
}

.sent {
  background: linear-gradient(45deg, #1e90ff, #00bfff); /* Gradient for sent messages */
  color: white;
  align-self: flex-end;
}

.received {
  background: linear-gradient(45deg, #f0f0f0, #ffffff); /* Gradient for received messages */
  color: #333;
  align-self: flex-start;
}

#messageInputContainer {
  display: flex;
  padding: 10px;
  background-color: #f8f9fa;
  border-top: 1px solid #ccc;
}

#messageInput {
  flex: 1;
  padding: 10px;
  font-size: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-right: 10px;
  background-color: #fff;
  color: #333;
}

#sendButton {
  padding: 8px 16px;
  font-size: 16px;
  border-radius: 8px;
  background: linear-gradient(45deg, #28a745, #00d84b); /* Green gradient for send button */
  color: white;
  width: 30%;
  align-self: center;
  margin-top: 12px;
}

#sendButton:focus {
  border: 2px solid yellow;
}

/* Footer Soft Keys */
footer.softkey {
  display: flex;
  justify-content: space-between;
  padding: 6px;
  background: linear-gradient(45deg, #ff6f61, #ff9a8b); /* Gradient footer */
  color: white;
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
}

footer .softkey div {
  flex: 1;
  text-align: center;
}

/* Animations for Transitions */
#mainPage,
#chatPage {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
#sendButton {
  width: 30px; /* Button ka width */
  height: 30px; /* Button ka height */
  background-image: url('right-pic.png'); /* Image ka path yahan daalein */
  background-size: cover; /* Image ko button ke size ke hisaab se adjust karein */
  background-position: center; /* Image ko center mein position karein */
  border: none; /* Border ko hataayein agar chahte hain */
  cursor: pointer; /* Pointer cursor jab button par ho */
}

</style>
</head>
<body>
  <!-- Main Page -->
  <div id="mainPage" class="active">
    <header>Chat App</header>
    <input type="text" id="searchInput" class="navItem" placeholder="Search for a user" tabindex="1" />
    <button id="searchButton" class="navItem" tabindex="2">Search</button>
    <button id="worldChatButton" class="navItem" tabindex="3">World Chat</button>
    <div id="privateChatList">
      <h4>Your Private Chats:</h4>
    </div>
  </div>

  <!-- Chat Page -->
  <div id="chatPage">
    <header id="chatHeader">Chat</header>
    <div id="chatBox">
      <div class="empty-message"></div>
    </div>
    <div id="messageInputContainer">
      <input type="text" id="messageInput" class="navItem" placeholder="Enter your message" tabindex="4" />
      <button id="sendButton" class="navItem image-btn" tabindex="5"</button>
    </div>
    <footer class="softkey">
  <div id="softKeysContainer">
      <div id="softkey-left">Back</div>
      <div id="softkey-center"></div>
      <div id="softkey-right"></div>
  </div>
</footer>
<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCE5gLp99K4IUq6V-BhlmgOcTtTjjG6WpU",
  authDomain: "chat-app-9d3d2.firebaseapp.com",
  databaseURL: "https://chat-app-9d3d2-default-rtdb.firebaseio.com",
  projectId: "chat-app-9d3d2",
  storageBucket: "chat-app-9d3d2.appspot.com",
  messagingSenderId: "110218700281",
  appId: "1:110218700281:web:470b92a7e4b223a0660928",
  measurementId: "G-PZKV7JTD5K"
};

firebase.initializeApp(firebaseConfig);

let username = localStorage.getItem("username");
let password = localStorage.getItem("password");
const mainPage = document.getElementById("mainPage");
const chatPage = document.getElementById("chatPage");
const chatHeader = document.getElementById("chatHeader");
const chatBox = document.getElementById("chatBox");
const privateChatList = document.getElementById("privateChatList");
const messageInput = document.getElementById("messageInput");
let currentChatType = null;
let messages = [];

// Check for restart message and show it once
const restartMessageShown = localStorage.getItem("restartMessageShown");

if (restartMessageShown !== "true") {
  localStorage.setItem("restartMessageShown", "false");
}

window.onload = function () {
  if (!username) {
    username = prompt("Enter your name:");
    if (username) {
      password = prompt("Enter your password:");
      localStorage.setItem("username", username);
      localStorage.setItem("password", password);
      firebase.database().ref("users/" + username).set({
        name: username,
        password: password,
        timestamp: Date.now(),
      });
    }
  } else {
    if (!password) {
      password = prompt("Enter your password:");
      localStorage.setItem("password", password);
    }
    
    const enteredPassword = prompt("Enter your password:");
    if (enteredPassword === password) {
      loadPrivateChats();
    } else {
      alert("Invalid code");
      window.location.reload();
    }
  }

  if (localStorage.getItem("restartMessageShown") === "false") {
    if (confirm("Need to restart the app. Do you want to close it now?")) {
      localStorage.setItem("restartMessageShown", "true");
      window.close();
    }
  }

  // Show ad on page load
  showKaiAd();
  setInterval(showKaiAd, 2 * 60 * 1000); // 1 minute interval
};

// Function to show KaiAd
function showKaiAd() {
  getKaiAd({
    publisher: 'da08737d-861e-4ebe-bbbb-8fb90d004d39',
    app: 'Chit_Chat',
    slot: 'Chit_Chat__slot',
    onerror: err => console.error('Custom catch:', err),
    onready: ad => {
      previouslyFocusedElement = document.activeElement;
      ad.call('display');
      
      ad.on('display', () => {
        document.getElementById("softKeysContainer").style.display = "none";
      });

      ad.on('close', () => {
        document.getElementById('sendButton').focus();
        document.getElementById("softKeysContainer").style.display = "block";
      });
    }
  });
}


  // Search for a user
  document.getElementById("searchButton").onclick = function () {
    const searchName = document.getElementById("searchInput").value.trim();
    if (!searchName) return alert("Please enter a name.");
    firebase.database().ref("users/" + searchName).once("value", function (snapshot) {
      if (snapshot.exists()) {
        alert("User found! Starting private chat...");
        openChat(searchName);
        updatePrivateChatList(username, searchName); // Add to both users' private chat list
      } else {
        alert("User not found.");
      }
    });
  };
  
  
// Load private chats and listen for new messages
function loadPrivateChats() {
  privateChatList.innerHTML = "<h4>Your Private Chats:</h4>";

  // Listen for new private chat partners
  firebase.database().ref("privateChats/" + username).on("child_added", function (snapshot) {
    const partnerName = snapshot.key;
    const userElement = document.createElement("div");
    userElement.className = "user navItem";
    userElement.textContent = partnerName;
    userElement.tabIndex = 7;

    // Add click event to open chat and mark messages as seen
    userElement.onclick = function () {
      openChat(partnerName);
      markMessagesAsSeen(partnerName, userElement);
    };
    userElement.onkeydown = function (e) {
      if (e.key === "Enter") {
        openChat(partnerName);
        markMessagesAsSeen(partnerName, userElement);
      }
    };
    privateChatList.appendChild(userElement);

    // Listen for messages in the specific private chat
    const chatRef = firebase.database().ref(`privateChats/${username}/${partnerName}`);

    // Real-time listener for new messages
    chatRef.on("child_added", function (msgSnapshot) {
      const data = msgSnapshot.val();

      // If the message is not seen and sent by the partner, turn the name red
      if (!data.seen && data.from === partnerName) {
        userElement.style.color = "red"; // Turn name red
      }
    });

    // Real-time listener for updates (e.g., marking messages as seen)
    chatRef.on("child_changed", function (msgSnapshot) {
      const data = msgSnapshot.val();

      // If the message is marked as seen, revert name color to black
      if (data.seen && data.from === partnerName) {
        const hasUnseenMessages = checkForUnseenMessages(partnerName);
        if (!hasUnseenMessages) {
          userElement.style.color = "black"; // Turn name back to black
        }
      }
    });
  });
}

// Function to mark messages as seen
function markMessagesAsSeen(partnerName, userElement) {
  const chatRef = firebase.database().ref(`privateChats/${username}/${partnerName}`);
  chatRef.once("value", function (snapshot) {
    snapshot.forEach(function (msgSnapshot) {
      const message = msgSnapshot.val();

      // Update the "seen" status for messages sent by the partner
      if (message && message.from === partnerName && !message.seen) {
        chatRef.child(msgSnapshot.key).update({ seen: true });
      }
    });

    // Reset partner's name color to black after marking as seen
    userElement.style.color = "black";
  });
}

// Helper function to check for unseen messages
function checkForUnseenMessages(partnerName) {
  let hasUnseen = false;
  const chatRef = firebase.database().ref(`privateChats/${username}/${partnerName}`);
  chatRef.once("value", function (snapshot) {
    snapshot.forEach(function (msgSnapshot) {
      const message = msgSnapshot.val();
      if (message && !message.seen && message.from === partnerName) {
        hasUnseen = true;
      }
    });
  });
  return hasUnseen;
}


function openChat(chatType) {
    currentChatType = chatType;
    messages = []; // Reset messages on chat open
    mainPage.classList.remove("active");
    chatPage.classList.add("active");
    chatHeader.textContent = chatType === "world" ? "World Chat" : `Chat with ${chatType}`;
    chatBox.innerHTML = '<div class="empty-message"></div>';

    // Ensure the listener is not added multiple times
    const chatRef = chatType === "world"
        ? firebase.database().ref("worldChat")
        : firebase.database().ref("privateChats/" + username + "/" + chatType);

    // Remove any existing listeners before adding a new one
    chatRef.off();

    // Add a new listener for the current chat
    chatRef.orderByChild("timestamp").limitToLast(chatType === "world" ? 2 : 10).on("child_added", function (snapshot) {
        const data = snapshot.val();
        if (data && data.message) {
            // Check if the message already exists in the messages array
            if (messages.some(msg => msg.id === snapshot.key)) return;

            const messageElement = document.createElement("div");
            messageElement.className = "message " + (data.from === username ? "sent" : "received");
            messageElement.textContent = `${data.from}: ${data.message}`;
            messageElement.id = `msg-${snapshot.key}`;  // Assign unique id
            messageElement.tabIndex = 8;  // Focusable for navigation
            chatBox.appendChild(messageElement);

            messages.push({ id: snapshot.key, element: messageElement });
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    });

    // Focus the message input field after opening the chat
    setTimeout(function () {
        document.getElementById("messageInput").focus();
    }, 100);
}


document.getElementById("sendButton").onclick = function () {
  const message = messageInput.value.trim();
  if (!message) return;

  // Ensure the message isn't sent multiple times
  if (messages.length && messages[messages.length - 1].textContent === message) {
    return; // Skip if the same message is sent consecutively
  }

  const chatRef = currentChatType === "world"
    ? firebase.database().ref("worldChat").push()
    : firebase.database().ref("privateChats/" + username + "/" + currentChatType).push();

  chatRef.set({
    from: username,
    message: message,
    timestamp: Date.now(),
    seen: false,
  });

  // Only push the message to the recipient's chat once
  if (currentChatType !== "world") {
    firebase.database().ref("privateChats/" + currentChatType + "/" + username).push().set({
      from: username,
      message: message,
      timestamp: Date.now(),
      seen: false,
    });
  }

  messageInput.value = "";
};


// Back functionality using Backspace key
document.addEventListener("keydown", function (e) {
  if (e.key === "SoftLeft") {
    if (chatPage.classList.contains("active")) {
      chatPage.classList.remove("active");
      mainPage.classList.add("active");
      resetNavigation();
    }
  }
});

// Reset navigation when returning to main page
function resetNavigation() {
  const elements = Array.from(document.querySelectorAll(".navItem"));
  elements[0].focus();
}

// Navigation using arrow keys
function navigate(offset) {
  const elements = Array.from(document.querySelectorAll(".navItem"));
  const index = elements.indexOf(document.activeElement);
  const target = elements[index + offset];
  if (target) target.focus();
}

document.addEventListener("keydown", function (e) {
  if (e.key === "ArrowDown") navigate(1);
  if (e.key === "ArrowUp") navigate(-1);
  if (e.key === "Enter") {
    const activeElement = document.activeElement;
    if (activeElement.classList.contains("user")) {
      activeElement.click();
    }
  }
  if (e.key === "SoftLeft") {
    if (document.activeElement === messageInput) {
      if (messages.length > 0) {
        messages[messages.length - 1].focus();
      }
    } else if (document.activeElement === messages[messages.length - 1]) {
      document.getElementById("sendButton").focus();
    }
  }
});

// World chat button
document.getElementById("worldChatButton").onclick = function () {
  openChat("world");
};

</script>
<script src="kaiads.v5.min.js"></script>

</body>
</html>
