<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Private Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="kaiads.v5.min.js"></script> 
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      background: linear-gradient(45deg, #ff6f61, #ff9a8b);
      color: white;
      text-align: center;
      padding: 8px;
      font-size: 14px;
      font-weight: bold;
      position: relative;
      width: 100%;
      z-index: 10;
    }

    .navItem {
      display: block;
      width: 90%;
      margin: 8px auto;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: linear-gradient(145deg, #fff, #e4e4e4);
      transition: all 0.3s ease;
    }

    .navItem:focus {
      border: 2px solid #007bff;
      border-color: #007bff;
    }

    button {
      background: linear-gradient(45deg, #1e90ff, #00bfff);
      color: black;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      padding: 8px 16px;
      width: 80%;
      border-radius: 6px;
      margin-top: 8px;
      transition: background 0.3s ease;
    }

    button:hover {
      background: linear-gradient(45deg, #00bfff, #1e90ff);
    }

    #loginPage,
    #mainPage,
    #chatPage {
      flex: 1;
      overflow: auto;
      display: none;
    }

    #loginPage.active,
    #mainPage.active,
    #chatPage.active {
      display: flex;
      flex-direction: column;
    }

    #loginPage {
      justify-content: center;
      align-items: center;
      background-color: #f4f4f9;
      color: #333;
      height: 100vh;
    }

    #loginContainer {
      width: 90%;
      text-align: center;
    }

    #privateChatList {
      padding: 8px;
      color: black;
      font-weight: bold;
      text-align: center;
    }

    .chat-item {
      padding: 8px;
      background: linear-gradient(145deg, #ffffff, #f7f7f7);
      border-radius: 6px;
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .chat-item:hover {
      background: linear-gradient(145deg, #f0f0f0, #ffffff);
    }

    #chatHeader {
      font-size: 16px;
      font-weight: bold;
      padding: 8px;
      background: linear-gradient(45deg, #ff6f61, #ff9a8b);
      color: white;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #chatBox {
      position: relative;
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background-color: #e9ecef;
      border-top: 1px solid #ccc;
      background-size: cover;
      background-position: center;
    }

    .message-container {
      display: flex;
      flex-direction: column;
      margin: 6px 0;
      max-width: 70%;
      position: relative;
    }

    .message {
      padding: 8px;
      border-radius: 6px;
      font-size: 12px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .sent-container {
      align-self: flex-end;
    }

    .received-container {
      align-self: flex-start;
    }

    .sent {
      background: linear-gradient(45deg, #1e90ff, #00bfff);
      color: white;
    }

    .received {
      background: linear-gradient(145deg, #f0f0f0, #ffffff);
      color: #333;
    }

    .seen-by-both {
      color: green !important;
    }

    .seen-timestamp {
      font-size: 10px;
      color: white;
      margin-top: 4px;
      align-self: flex-end;
    }

    .reaction {
      font-size: 14px;
      position: absolute;
      bottom: 0;
      right: 0;
      color: #555;
      padding: 2px;
    }

    #messageInputContainer {
      display: flex;
      align-items: center;
      padding: 8px;
      background-color: #f8f9fa;
      border-top: 1px solid #ccc;
      gap: 8px;
    }

    #imageButton {
      width: 32px;
      height: 32px;
      background-image: url('left-pic.png');
      background-size: cover;
      background-position: center;
      border: none;
      cursor: pointer;
    }

    #imageButton:focus {
      border: 2px solid #007bff;
    }

    #messageInput {
      flex: 1;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      color: #333;
    }

    #sendButton {
      width: 32px;
      height: 32px;
      background-image: url('right-pic.png');
      background-size: cover;
      background-position: center;
      border: none;
      cursor: pointer;
      margin: 0;
      align-self: center;
    }

    #sendButton:focus {
      border: 2px solid #007bff;
    }

    #softKeysContainer {
      height: 1.1rem;
      line-height: 1.1rem;
      width: 100%;
      background: linear-gradient(45deg, #ff6f61, #ff9a8b);
      position: fixed;
      bottom: 0;
      display: none;
    }

    #softKeysContainer.active {
      display: block;
    }

    #softkey-left,
    #softkey-center,
    #softkey-right {
      text-align: right;
      font-size: 15px;
      color: #ffffff;
    }

    .message img {
      max-width: 100%;
      height: 120px;
      border-radius: 6px;
      margin-top: 4px;
    }

    .message:focus {
      outline: none;
      box-shadow: 0 0 10px 2px rgba(0, 123, 255, 0.7);
    }

    .fullscreen-image {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 240px;
      height: 320px;
      object-fit: fill;
      background-color: black;
      z-index: 9999;
    }

    .emoji-container {
      display: none;
      position: absolute;
      top: -40px;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px;
      z-index: 100;
    }

    .emoji {
      display: inline-block;
      padding: 4px;
      font-size: 16px;
      cursor: pointer;
    }

    .emoji:focus {
      outline: 2px solid #007bff;
      background: #e0e0e0;
    }

    /* Themes */
    .rainbow-theme { background: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #00ffff, #0000ff, #8000ff); color: #333; }
    .skyway-theme { background: linear-gradient(180deg, #87CEEB, #E0F7FA); color: #333; }
    .night-theme { background: linear-gradient(180deg, #1a1a2e, #16213e); color: #e0e0e0; }
    .forest-theme { background: linear-gradient(180deg, #2e4f2e, #4a704a); color: #e0e0e0; }
    .sunset-theme { background: linear-gradient(180deg, #ff4500, #ff8c00); color: #333; }
    .ocean-theme { background: linear-gradient(180deg, #1e90ff, #00b7eb); color: #333; }
    .lavender-theme { background: linear-gradient(180deg, #e6e6fa, #d8bfd8); color: #333; }
    .galaxy-theme { background: linear-gradient(180deg, #0d1b2a, #1b263b); color: #e0e0e0; }
    .neon-theme { background: linear-gradient(180deg, #ff00ff, #00ffcc); color: #333; }
    .desert-theme { background: linear-gradient(180deg, #f4a261, #e76f51); color: #333; }
    .aurora-theme { background: linear-gradient(180deg, #2a9d8f, #264653); color: #e0e0e0; }
    .candy-theme { background: linear-gradient(180deg, #ff70a6, #ff9770); color: #333; }
    .neon-glowing-theme { background: linear-gradient(45deg, #00ffcc, #ff00ff, #00ccff, #ffcc00); color: #fff; text-shadow: 0 0 5px #00ffcc, 0 0 10px #ff00ff; }
    .cosmic-dust-theme { background: linear-gradient(135deg, #1e1e3f, #3f2a5d, #6b4984, #9d75a8); color: #e0e0e0; }
    .tropical-vibe-theme { background: linear-gradient(45deg, #ff6b6b, #ffa07a, #98ff98, #20b2aa); color: #333; }
    .electric-pulse-theme { background: linear-gradient(90deg, #ff007a, #00d4ff, #ff00cc, #00ff7f); color: #fff; }
    .mystic-dawn-theme { background: linear-gradient(180deg, #4b0082, #9400d3, #ff1493, #ff69b4); color: #e0e0e0; }
    .firestorm-theme { background: linear-gradient(45deg, #ff4500, #ff8c00, #ff0000, #dc143c); color: #fff; }
    .glacial-glow-theme { background: linear-gradient(135deg, #00ced1, #4682b4, #00b7eb, #87cefa); color: #333; }
    .retro-wave-theme { background: linear-gradient(90deg, #ff77ff, #00ffff, #ff00ff, #00ffcc); color: #fff; }
    .golden-horizon-theme { background: linear-gradient(180deg, #ffd700, #ff8c00, #ffa500, #ff4500); color: #333; }

    /* Custom Alert Styles */
    .custom-alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #ff6f61;
      border-radius: 6px;
      padding: 20px;
      z-index: 10000;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .custom-alert-header {
      background: linear-gradient(45deg, #ff6f61, #ff9a8b);
      color: white;
      padding: 8px;
      font-weight: bold;
      border-radius: 4px 4px 0 0;
      margin: -20px -20px 10px -20px;
    }

    .custom-alert .navItem {
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="loginPage" class="active">
    <header>Chit Chat - Login</header>
    <div id="loginContainer">
      <input type="text" id="usernameInput" class="navItem" placeholder="Enter your name" tabindex="1" />
      <input type="password" id="passwordInput" class="navItem" placeholder="Enter your password" tabindex="2" />
      <button id="signInButton" class="navItem" tabindex="3">Sign In</button>
    </div>
  </div>

  <div id="mainPage">
    <header>Private Chat</header>
    <input type="text" id="searchInput" class="navItem" placeholder="Search for a user" tabindex="1" />
    <button id="searchButton" class="navItem" tabindex="2">Search</button>
    <button id="worldChatButton" class="navItem" tabindex="3" onclick="window.location.href='world_chat.html'">World Chat</button>
    <button id="groupChatButton" class="navItem" tabindex="4" onclick="window.location.href='groups.html'">Group Chat</button>
    <button id="changeBackgroundButton" class="navItem" tabindex="5">Change Chat Background</button>
    <button id="changeThemeButton" class="navItem" tabindex="6">Change Theme</button>
    <div id="privateChatList">
      <h4>Your Private Chats:</h4>
    </div>
  </div>

  <div id="chatPage">
    <header id="chatHeader">Chat</header>
    <div id="chatBox">
      <div class="empty-message"></div>
    </div>
    <div id="messageInputContainer">
      <button id="imageButton" class="navItem" tabindex="3"></button>
      <input type="text" id="messageInput" class="navItem" placeholder="Enter your message" tabindex="4" />
      <button id="sendButton" class="navItem" tabindex="5"></button>
    </div>
  </div>
  <div id="softKeysContainer">
    <div id="softkey-left"></div>
    <div id="softkey-center"></div>
    <div id="softkey-right">Back</div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCcPZRtjWHfW-5fTNsXeEfT7IrAx7O2vRM",
      authDomain: "chit-chat-359a4.firebaseapp.com",
      projectId: "chit-chat-359a4",
      storageBucket: "chit-chat-359a4.appspot.com",
      messagingSenderId: "941229772449",
      appId: "1:941229772449:web:f0d6c439397e55dc076ae0",
      measurementId: "G-TJHQSFCVR0"
    };

    firebase.initializeApp(firebaseConfig);

    let username = localStorage.getItem("username");
    let password = localStorage.getItem("password");
    const loginPage = document.getElementById("loginPage");
    const mainPage = document.getElementById("mainPage");
    const chatPage = document.getElementById("chatPage");
    const chatHeader = document.getElementById("chatHeader");
    const chatBox = document.getElementById("chatBox");
    const privateChatList = document.getElementById("privateChatList");
    const messageInput = document.getElementById("messageInput");
    const imageButton = document.getElementById("imageButton");
    const sendButton = document.getElementById("sendButton");
    const changeBackgroundButton = document.getElementById("changeBackgroundButton");
    const changeThemeButton = document.getElementById("changeThemeButton");
    const softKeysContainer = document.getElementById("softKeysContainer");
    const signInButton = document.getElementById("signInButton");
    const usernameInput = document.getElementById("usernameInput");
    const passwordInput = document.getElementById("passwordInput");
    let currentChatType = null;
    let messages = [];
    let chatRef = null;
    let otherChatRef = null;
    let processedMessages = new Set();
    let pressCount = 0;
    let currentEmojiContainer = null;
    let shownAlerts = new Set();
    let isAlertActive = false;

    document.addEventListener("DOMContentLoaded", () => {
      const savedBackground = localStorage.getItem("chatBackground");
      const savedTheme = localStorage.getItem("chatTheme");
      if (savedBackground) {
        chatBox.style.backgroundImage = `url(${savedBackground})`;
      }
      if (savedTheme) {
        document.body.className = savedTheme;
      }
      if (username && password) {
        authenticateUser(username, password);
      } else {
        loginPage.classList.add("active");
        usernameInput.focus();
      }
    });

    function showCustomAlert(message, callback) {
      isAlertActive = true;
      const alertBox = document.createElement("div");
      alertBox.className = "custom-alert";
      alertBox.innerHTML = `
        <div class="custom-alert-header">Chit Chat</div>
        <p>${message}</p>
        <button id="alertOkButton" class="navItem">OK</button>
      `;
      document.body.appendChild(alertBox);

      const okButton = document.getElementById("alertOkButton");
      okButton.focus();
      okButton.onclick = () => {
        document.body.removeChild(alertBox);
        isAlertActive = false;
        if (callback) callback(true);
      };

      okButton.onkeydown = (e) => {
        if (e.key === "Enter") okButton.click();
      };
    }

    function showCustomPrompt(message, callback) {
      isAlertActive = true;
      const alertBox = document.createElement("div");
      alertBox.className = "custom-alert";
      alertBox.innerHTML = `
        <div class="custom-alert-header">Chit Chat</div>
        <p>${message}</p>
        <input type="text" id="promptInput" class="navItem" />
        <button id="promptOkButton" class="navItem">OK</button>
      `;
      document.body.appendChild(alertBox);

      const input = document.getElementById("promptInput");
      const okButton = document.getElementById("promptOkButton");
      input.focus();

      okButton.onclick = () => {
        const value = input.value.trim();
        document.body.removeChild(alertBox);
        isAlertActive = false;
        callback(value);
      };

      input.onkeydown = (e) => {
        if (e.key === "Enter") okButton.click();
      };

      input.onkeydown = (e) => {
        if (e.key === "ArrowDown") {
          okButton.focus();
        }
      };

      okButton.onkeydown = (e) => {
        if (e.key === "ArrowUp") {
          input.focus();
        }
      };
    }

    signInButton.onclick = function () {
      const enteredUsername = usernameInput.value.trim();
      const enteredPassword = passwordInput.value.trim();
      if (!enteredUsername || !enteredPassword) {
        showCustomAlert("Please enter both username and password.");
        return;
      }
      authenticateUser(enteredUsername, enteredPassword);
    };

    usernameInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        passwordInput.focus();
      }
    });

    passwordInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        signInButton.focus();
        signInButton.click();
      }
    });

    function registerPushNotifications() {
      if ('navigator.mozApps' in window) {
        const request = navigator.mozApps.getSelf();
        request.onsuccess = function() {
          const app = this.result;
          if (app) {
            navigator.push = navigator.push || {};
            const reg = navigator.push.register();
            reg.onsuccess = function(e) {
              const endpoint = e.result;
              localStorage.setItem("pushEndpoint", endpoint);
              console.log("Push endpoint registered:", endpoint);
            };
          }
        };
      }
    }

    function sendPushNotification(message, from) {
      if (Notification.permission === "granted") {
        new Notification(`New message from ${from}`, {
          body: message,
          icon: 'icons/icon56x56.png'
        });
      }
    }

    function showKaiAd() {
      getKaiAd({
        publisher: 'da08737d-861e-4ebe-bbbb-8fb90d004d39',
        app: 'Chit_Chat',
        slot: 'Chit_Chat__slot',
        onerror: err => console.error('Custom catch:', err),
        onready: ad => {
          const previouslyFocusedElement = document.activeElement;
          ad.call('display');
          ad.on('display', () => softKeysContainer.style.display = "none");
          ad.on('close', () => {
            if (previouslyFocusedElement) previouslyFocusedElement.focus();
            softKeysContainer.style.display = "block";
          });
        }
      });
    }

    function authenticateUser(enteredUsername, enteredPassword) {
      firebase.database().ref("users/" + enteredUsername).once("value", function (snapshot) {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          if (userData.password === enteredPassword) {
            username = enteredUsername;
            password = enteredPassword;
            localStorage.setItem("username", username);
            localStorage.setItem("password", password);
            loginPage.classList.remove("active");
            mainPage.classList.add("active");
            loadPrivateChats();
            setupPresence();
            registerPushNotifications();
            showKaiAd();
            setInterval(showKaiAd, 2 * 60 * 1000);
          } else {
            showCustomAlert("Incorrect password. Please try again.", () => {
              passwordInput.value = "";
              passwordInput.focus();
            });
          }
        } else {
          firebase.database().ref("users/" + enteredUsername).set({
            name: enteredUsername,
            password: enteredPassword,
            timestamp: Date.now(),
          });
          username = enteredUsername;
          password = enteredPassword;
          localStorage.setItem("username", username);
          localStorage.setItem("password", password);
          loginPage.classList.remove("active");
          mainPage.classList.add("active");
          loadPrivateChats();
          setupPresence();
          registerPushNotifications();
          showKaiAd();
          setInterval(showKaiAd, 2 * 60 * 1000);
        }
      });
    }

    function setupPresence() {
      const presenceRef = firebase.database().ref(`presence/${username}`);
      const connectedRef = firebase.database().ref(".info/connected");

      connectedRef.on("value", (snap) => {
        if (snap.val() === true) {
          presenceRef.set(true);
          presenceRef.onDisconnect().set(false);
        }
      });
    }

    function isUserBlocked(blocker, blocked) {
      return firebase.database().ref(`blocked/${blocker}/${blocked}`).once("value").then(snapshot => snapshot.exists());
    }

    function blockUser(blocker, blocked) {
      firebase.database().ref(`blocked/${blocker}/${blocked}`).set(true);
      firebase.database().ref(`privateChats/${blocker}/${blocked}`).remove();
      firebase.database().ref(`privateChats/${blocked}/${blocker}`).remove();
    }

    function unblockUser(blocker, blocked) {
      firebase.database().ref(`blocked/${blocker}/${blocked}`).remove();
    }

    function loadPrivateChats() {
      privateChatList.innerHTML = "<h4>Your Private Chats:</h4>";
      firebase.database().ref("privateChats/" + username).on("child_added", function (snapshot) {
        const partnerName = snapshot.key;
        isUserBlocked(username, partnerName).then(blocked => {
          if (!blocked) {
            const userElement = document.createElement("div");
            userElement.className = "user navItem";
            userElement.textContent = partnerName;
            userElement.tabIndex = 7;

            userElement.onclick = function () {
              openChat(partnerName);
              markMessagesAsSeen(partnerName, userElement);
            };

            userElement.onkeydown = function (e) {
              if (e.key === "Enter") {
                if (!shownAlerts.has(partnerName)) {
                  showCustomPrompt(`Select an option for ${partnerName}:\nOptions:\n1. Chat\n2. Delete\n3. Block`, (choice) => {
                    shownAlerts.add(partnerName);
                    if (choice === "1") {
                      openChat(partnerName);
                      markMessagesAsSeen(partnerName, userElement);
                    } else if (choice === "2") {
                      firebase.database().ref(`privateChats/${username}/${partnerName}`).remove();
                      userElement.remove();
                    } else if (choice === "3") {
                      blockUser(username, partnerName);
                      userElement.remove();
                      showCustomAlert(`${partnerName} has been blocked and chat history deleted.`, () => {
                        document.getElementById("searchInput").focus();
                      });
                    }
                  });
                } else {
                  openChat(partnerName);
                  markMessagesAsSeen(partnerName, userElement);
                }
              }
            };
            privateChatList.appendChild(userElement);

            const chatRef = firebase.database().ref(`privateChats/${username}/${partnerName}`);
            chatRef.on("child_added", function (msgSnapshot) {
              const data = msgSnapshot.val();
              if (!data.seen && data.from === partnerName) {
                userElement.style.color = "red";
                sendPushNotification(data.message || "Image received", partnerName);
              }
            });

            chatRef.on("child_changed", function (msgSnapshot) {
              const data = msgSnapshot.val();
              if (data.seen && data.from === partnerName) {
                const hasUnseenMessages = checkForUnseenMessages(partnerName);
                if (!hasUnseenMessages) {
                  updateUserColor(partnerName, userElement);
                }
              }
            });

            firebase.database().ref(`presence/${partnerName}`).on("value", (snap) => {
              updateUserColor(partnerName, userElement);
            });
          }
        });
      });
    }

    function updateUserColor(partnerName, userElement) {
      const presenceRef = firebase.database().ref(`presence/${partnerName}`);
      presenceRef.once("value", (snap) => {
        const isOnline = snap.val();
        const hasUnseen = checkForUnseenMessages(partnerName);
        if (hasUnseen) {
          userElement.style.color = "red";
        } else if (isOnline) {
          userElement.style.color = "green";
        } else {
          userElement.style.color = "black";
        }
      });
    }

    function markMessagesAsSeen(partnerName, userElement) {
      const chatRef = firebase.database().ref(`privateChats/${username}/${partnerName}`);
      chatRef.once("value", function (snapshot) {
        snapshot.forEach(function (msgSnapshot) {
          const message = msgSnapshot.val();
          if (message && message.from === partnerName && !message.seen) {
            const seenTimestamp = Date.now();
            chatRef.child(msgSnapshot.key).update({ seen: true, seenTimestamp });
            firebase.database().ref(`privateChats/${partnerName}/${username}/${msgSnapshot.key}`).update({ seen: true, seenTimestamp });
          }
        });
        updateUserColor(partnerName, userElement);
      });
    }

    function checkForUnseenMessages(partnerName) {
      let hasUnseen = false;
      const chatRef = firebase.database().ref(`privateChats/${username}/${partnerName}`);
      chatRef.once("value", function (snapshot) {
        snapshot.forEach(function (msgSnapshot) {
          const message = msgSnapshot.val();
          if (message && !message.seen && message.from === partnerName) {
            hasUnseen = true;
          }
        });
      });
      return hasUnseen;
    }

    function checkBothSeen(messageId) {
      const senderRef = firebase.database().ref(`privateChats/${username}/${currentChatType}/${messageId}`);
      const receiverRef = firebase.database().ref(`privateChats/${currentChatType}/${username}/${messageId}`);
      
      return Promise.all([
        senderRef.once('value'),
        receiverRef.once('value')
      ]).then(([senderSnap, receiverSnap]) => {
        const senderData = senderSnap.val();
        const receiverData = receiverSnap.val();
        return senderData && receiverData && senderData.seen && receiverData.seen;
      });
    }

    function updateMessageColor(messageId) {
      checkBothSeen(messageId).then(bothSeen => {
        const messageElement = document.getElementById(`msg-${messageId}`);
        if (messageElement) {
          if (bothSeen) {
            messageElement.classList.add('seen-by-both');
          } else {
            messageElement.classList.remove('seen-by-both');
          }
        }
      });
    }

    function sendMessage(content, type) {
      const messageData = {
        from: username,
        timestamp: Date.now(),
        seen: false,
      };

      if (type === "text") {
        messageData.message = content;
      } else {
        messageData.mediaUrl = content;
        messageData.mediaType = type;
      }

      const senderChatRef = firebase.database().ref(`privateChats/${username}/${currentChatType}`).push();
      const messageId = senderChatRef.key;
      const receiverChatRef = firebase.database().ref(`privateChats/${currentChatType}/${username}/${messageId}`);

      senderChatRef.set(messageData);
      receiverChatRef.set(messageData);

      if (type === "text") {
        senderChatRef.update({ seen: false });
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
    }

    function openChat(chatType) {
      currentChatType = chatType;
      messages = [];
      chatBox.innerHTML = "";
      mainPage.classList.remove("active");
      chatPage.classList.add("active");
      softKeysContainer.classList.add("active");
      chatHeader.textContent = `Chat with ${chatType}`;
      processedMessages.clear();

      if (chatRef) chatRef.off();
      if (otherChatRef) otherChatRef.off();

      chatRef = firebase.database().ref(`privateChats/${username}/${chatType}`);
      otherChatRef = firebase.database().ref(`privateChats/${chatType}/${username}`);

      chatRef.orderByChild("timestamp").limitToLast(20).on("child_added", function (snapshot) {
        const messageId = snapshot.key;
        if (processedMessages.has(messageId)) return;

        const data = snapshot.val();
        if (data && (data.message || data.mediaUrl)) {
          processedMessages.add(messageId);
          
          const messageContainer = document.createElement("div");
          messageContainer.className = `message-container ${data.from === username ? "sent-container" : "received-container"}`;
          
          const messageElement = document.createElement("div");
          messageElement.className = `message ${data.from === username ? "sent" : "received"}`;
          messageElement.id = `msg-${messageId}`;
          messageElement.tabIndex = 8;

          if (data.mediaType === "image") {
            const img = document.createElement("img");
            img.src = data.mediaUrl;
            img.loading = "lazy";
            img.alt = "Loading...";
            img.onload = () => img.alt = "";
            img.onerror = () => img.alt = "Failed to load image";
            img.tabIndex = 9;
            messageElement.appendChild(img);
          } else {
            const textSpan = document.createElement("span");
            textSpan.textContent = `${data.from}: ${data.message}`;
            messageElement.appendChild(textSpan);
          }

          if (data.seen && data.seenTimestamp && data.from === username) {
            const timestampSpan = document.createElement("span");
            timestampSpan.className = "seen-timestamp";
            timestampSpan.textContent = `Seen: ${formatTimestamp(data.seenTimestamp)}`;
            messageElement.appendChild(timestampSpan);
          }

          messageContainer.appendChild(messageElement);

          if (data.reaction) {
            const reactionSpan = document.createElement("span");
            reactionSpan.className = "reaction";
            reactionSpan.textContent = data.reaction;
            messageContainer.appendChild(reactionSpan);
          }

          const emojiContainer = document.createElement("div");
          emojiContainer.className = "emoji-container";
          const emojis = ["👍", "😂", "❤", "😢", "😡", "😮"];
          emojis.forEach(emoji => {
            const span = document.createElement("span");
            span.className = "emoji";
            span.textContent = emoji;
            span.tabIndex = 10;
            emojiContainer.appendChild(span);
          });
          messageContainer.appendChild(emojiContainer);

          chatBox.appendChild(messageContainer);
          messages.push({ id: messageId, element: messageContainer });
          chatBox.scrollTop = chatBox.scrollHeight;

          updateMessageColor(messageId);
        }
      });

      chatRef.on("child_changed", function (snapshot) {
        const messageId = snapshot.key;
        const data = snapshot.val();
        const messageElement = document.getElementById(`msg-${messageId}`);
        if (messageElement) {
          if (data.reaction) {
            let reactionSpan = messageElement.parentElement.querySelector(".reaction");
            if (!reactionSpan) {
              reactionSpan = document.createElement("span");
              reactionSpan.className = "reaction";
              messageElement.parentElement.appendChild(reactionSpan);
            }
            reactionSpan.textContent = data.reaction;
          }
          if (data.seen && data.seenTimestamp && data.from === username) {
            let timestampSpan = messageElement.querySelector(".seen-timestamp");
            if (!timestampSpan) {
              timestampSpan = document.createElement("span");
              timestampSpan.className = "seen-timestamp";
              messageElement.appendChild(timestampSpan);
            }
            timestampSpan.textContent = `Seen: ${formatTimestamp(data.seenTimestamp)}`;
          }
          updateMessageColor(messageId);
        }
      });

      otherChatRef.on("child_changed", function (snapshot) {
        const messageId = snapshot.key;
        updateMessageColor(messageId);
      });

      setTimeout(function () {
        document.getElementById("messageInput").focus();
      }, 100);

      messageInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          sendButton.click();
        }
      });

      sendButton.onclick = function () {
        const message = messageInput.value.trim();
        if (message) {
          sendMessage(message, "text");
          messageInput.value = "";
        }
      };

      imageButton.onclick = function () {
        sendImage();
      };
    }

    function toggleFullScreen(img) {
      if (img.classList.contains("fullscreen-image")) {
        img.classList.remove("fullscreen-image");
      } else {
        img.classList.add("fullscreen-image");
      }
    }

    function uploadFileToCloudinary(file, onProgress) {
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "Chitchat");
        formData.append("cloud_name", "dcv3kn2gu");

        const xhr = new XMLHttpRequest();
        xhr.open("POST", `https://api.cloudinary.com/v1_1/dcv3kn2gu/upload`, true);

        xhr.upload.onprogress = function (e) {
          if (e.lengthComputable) {
            onProgress((e.loaded / e.total) * 100);
          }
        };

        xhr.onload = function () {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            resolve(response.secure_url);
          } else {
            reject(new Error("Upload failed"));
          }
        };

        xhr.onerror = function () {
          reject(new Error("Upload failed"));
        };

        xhr.send(formData);
      });
    }

    function sendImage() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          uploadFileToCloudinary(file, (progress) => {
            console.log(`Upload progress: ${progress}%`);
          }).then((url) => {
            sendMessage(url, "image");
          }).catch((error) => {
            console.error("Error uploading image:", error);
          });
        }
      };
      input.click();
    }

    document.getElementById("searchButton").onclick = function () {
      const searchName = document.getElementById("searchInput").value.trim();
      if (!searchName) return showCustomAlert("Please enter a name.");

      firebase.database().ref("users/" + searchName).once("value", function (snapshot) {
        if (snapshot.exists()) {
          Promise.all([
            isUserBlocked(username, searchName),
            isUserBlocked(searchName, username)
          ]).then(([userBlocked, blockedByUser]) => {
            if (userBlocked) {
              showCustomAlert(`User ${searchName} is blocked. Do you want to unblock and chat?`, (ok) => {
                if (ok) {
                  unblockUser(username, searchName);
                  showCustomAlert("User unblocked! Starting private chat...", () => {
                    openChat(searchName);
                    updatePrivateChatList(username, searchName);
                  });
                } else {
                  document.getElementById("searchInput").focus();
                }
              });
            } else if (blockedByUser) {
              showCustomAlert(`${searchName} has blocked you.`, () => {
                document.getElementById("searchInput").focus();
              });
            } else {
              showCustomAlert("User found! Starting private chat...", () => {
                openChat(searchName);
                updatePrivateChatList(username, searchName);
              });
            }
          });
        } else {
          showCustomAlert("User not found.", () => {
            document.getElementById("searchInput").focus();
          });
        }
      });
    };

    changeBackgroundButton.onclick = function () {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          uploadFileToCloudinary(file, (progress) => {
            console.log(`Background upload progress: ${progress}%`);
          }).then((url) => {
            chatBox.style.backgroundImage = `url(${url})`;
            chatBox.style.backgroundSize = "cover";
            chatBox.style.backgroundPosition = "center";
            localStorage.setItem("chatBackground", url);
          }).catch((error) => {
            console.error("Error uploading background image:", error);
          });
        }
      };
      input.click();
    };

    changeThemeButton.onclick = function () {
      const themes = [
        "rainbow-theme", "skyway-theme", "night-theme", "forest-theme", "sunset-theme", "ocean-theme",
        "lavender-theme", "galaxy-theme", "neon-theme", "desert-theme", "aurora-theme", "candy-theme",
        "neon-glowing-theme", "cosmic-dust-theme", "tropical-vibe-theme", "electric-pulse-theme",
        "mystic-dawn-theme", "firestorm-theme", "glacial-glow-theme", "retro-wave-theme", "golden-horizon-theme"
      ];
      const currentTheme = document.body.className;
      const currentIndex = themes.indexOf(currentTheme);
      const nextIndex = (currentIndex + 1) % themes.length;
      const nextTheme = themes[nextIndex];
      document.body.className = nextTheme;
      localStorage.setItem("chatTheme", nextTheme);
    };

    function updatePrivateChatList(user1, user2) {
      firebase.database().ref("privateChats/" + user1 + "/" + user2).set(true);
      firebase.database().ref("privateChats/" + user2 + "/" + user1).set(true);
    }

    function showEmojiContainer(messageContainer) {
      if (currentEmojiContainer) {
        currentEmojiContainer.style.display = "none";
      }
      const emojiContainer = messageContainer.querySelector(".emoji-container");
      emojiContainer.style.display = "flex";
      currentEmojiContainer = emojiContainer;
      const firstEmoji = emojiContainer.querySelector(".emoji");
      if (firstEmoji) firstEmoji.focus();
    }

    function hideEmojiContainer() {
      if (currentEmojiContainer) {
        currentEmojiContainer.style.display = "none";
        currentEmojiContainer = null;
      }
    }

    function addReaction(messageId, emoji) {
      const messageRef = firebase.database().ref(`privateChats/${username}/${currentChatType}/${messageId}`);
      messageRef.update({ reaction: emoji });
      firebase.database().ref(`privateChats/${currentChatType}/${username}/${messageId}`).update({ reaction: emoji });
    }

    function navigate(offset) {
      const elements = Array.from(document.querySelectorAll(".navItem, .message, .emoji"));
      const index = elements.indexOf(document.activeElement);
      const target = elements[index + offset];
      if (target) target.focus();
    }

    document.addEventListener("keydown", function (e) {
      if (isAlertActive) {
        const alertBox = document.querySelector(".custom-alert");
        if (alertBox) {
          const input = alertBox.querySelector("#promptInput");
          const okButton = alertBox.querySelector("#promptOkButton") || alertBox.querySelector("#alertOkButton");
          if (e.key === "ArrowDown" && document.activeElement === input) {
            okButton.focus();
          } else if (e.key === "ArrowUp" && document.activeElement === okButton) {
            if (input) input.focus();
          }
        }
        return;
      }

      const fullscreenImage = document.querySelector(".fullscreen-image");
      if (fullscreenImage) {
        fullscreenImage.classList.remove("fullscreen-image");
        return;
      }

      if (e.key === "ArrowDown") {
        const messagesList = Array.from(document.querySelectorAll(".message"));
        const index = messagesList.indexOf(document.activeElement);
        if (index !== -1 && index < messagesList.length - 1) {
          messagesList[index + 1].focus();
        } else {
          navigate(1);
        }
      }

      if (e.key === "ArrowUp") {
        const messagesList = Array.from(document.querySelectorAll(".message"));
        const index = messagesList.indexOf(document.activeElement);
        if (index > 0) {
          messagesList[index - 1].focus();
        } else {
          navigate(-1);
        }
      }

      if (e.key === "ArrowLeft" && document.activeElement.className === "emoji") {
        const emojis = Array.from(document.activeElement.parentElement.children);
        const index = emojis.indexOf(document.activeElement);
        if (index > 0) emojis[index - 1].focus();
      }

      if (e.key === "ArrowRight" && document.activeElement.className === "emoji") {
        const emojis = Array.from(document.activeElement.parentElement.children);
        const index = emojis.indexOf(document.activeElement);
        if (index < emojis.length - 1) emojis[index + 1].focus();
      }

      if (e.key === "Enter") {
        const activeElement = document.activeElement;
        if (activeElement.className === "emoji") {
          const messageContainer = activeElement.closest(".message-container");
          const messageId = messageContainer.querySelector(".message").id.replace("msg-", "");
          addReaction(messageId, activeElement.textContent);
          hideEmojiContainer();
          messageContainer.querySelector(".message").focus();
        } else if (activeElement.className.includes("message")) {
          const img = activeElement.querySelector("img");
          if (img) {
            showCustomPrompt("Select an option:\nOptions:\n1. Fullscreen\n2. Delete", (choice) => {
              if (choice === "1") {
                toggleFullScreen(img);
              } else if (choice === "2") {
                const messageId = activeElement.id.replace("msg-", "");
                firebase.database().ref(`privateChats/${username}/${currentChatType}/${messageId}`).remove();
                firebase.database().ref(`privateChats/${currentChatType}/${username}/${messageId}`).remove();
                activeElement.parentElement.remove();
              }
            });
          } else {
            showEmojiContainer(activeElement.parentElement);
          }
        }
      }

      if (e.key === "SoftRight" || e.key === "SoftLeft") {
        if (chatPage.classList.contains("active")) {
          chatPage.classList.remove("active");
          mainPage.classList.add("active");
          softKeysContainer.classList.remove("active");
          document.getElementById("searchInput").focus();
          if (chatRef) chatRef.off();
          if (otherChatRef) otherChatRef.off();
        }
      }

      if (e.key === "5") {
        pressCount++;
        if (pressCount === 1) {
          const lastMessage = messages[messages.length - 1];
          if (lastMessage) lastMessage.element.querySelector(".message").focus();
        } else if (pressCount === 2) {
          sendButton.focus();
          pressCount = 0;
        }
      }
      if (e.key === "8") chatBox.scrollTop += 50;
      if (e.key === "2") chatBox.scrollTop -= 50;
    });
  </script>
</body>
</html>